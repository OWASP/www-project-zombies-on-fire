{% extends "base.html" %}

{% block title %}Tabletop Details{% endblock %}

{% block content %}
<div id="loading" class="loading">
    <div class="spinner"></div>
</div>

<div id="tabletop-content" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <h1 id="tabletop-title"></h1>
            <span id="tabletop-status" class="status-badge"></span>
        </div>
        <div>
            <a href="/app/dashboard" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h2>Overview</h2>
            <p id="tabletop-description" style="color: #666;"></p>

            <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Story Prompt</h3>
            <p id="tabletop-story" style="color: #666; font-style: italic;"></p>

            <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Progress</h3>
            <div class="progress-bar">
                <div id="progress-fill" class="fill"></div>
            </div>
            <p id="progress-text" style="color: #888; font-size: 0.9rem;"></p>
        </div>

        <div class="card">
            <h2>Actions</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <a id="questions-link" href="#" class="btn btn-primary">
                    Answer Questions
                </a>
                <a id="documents-link" href="#" class="btn btn-success hidden">
                    Generate Documents
                </a>
                <button onclick="deleteTabletop()" class="btn" style="background: #dc3545; color: white;">
                    Delete Tabletop
                </button>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 1.5rem;">
        <h2>Questions & Answers</h2>
        <div id="questions-list"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const tabletopId = {{ tabletop_id }};
    let tabletopData = null;

    async function loadTabletop() {
        try {
            const response = await apiCall(`/api/tabletops/${tabletopId}`);

            if (response.ok) {
                tabletopData = await response.json();
                displayTabletop(tabletopData);
            } else {
                window.location.href = '/app/dashboard';
            }
        } catch (error) {
            console.error('Error loading tabletop:', error);
        }
    }

    function displayTabletop(tabletop) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('tabletop-content').classList.remove('hidden');

        document.getElementById('tabletop-title').textContent = tabletop.title;
        document.getElementById('tabletop-status').textContent = tabletop.status.replace('_', ' ');
        document.getElementById('tabletop-status').className = `status-badge status-${tabletop.status}`;
        document.getElementById('tabletop-description').textContent = tabletop.description || 'No description provided.';
        document.getElementById('tabletop-story').textContent = tabletop.story_prompt || 'No story prompt provided.';

        // Progress
        const answeredCount = tabletop.questions.filter(q => q.answer).length;
        const totalCount = tabletop.questions.length;
        const progressPercent = (answeredCount / totalCount) * 100;

        document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        document.getElementById('progress-text').textContent = `${answeredCount} of ${totalCount} questions answered`;

        // Links
        document.getElementById('questions-link').href = `/app/tabletop/${tabletop.id}/questions`;

        if (tabletop.is_complete) {
            document.getElementById('documents-link').classList.remove('hidden');
            document.getElementById('documents-link').href = `/app/tabletop/${tabletop.id}/documents`;
        }

        // Questions list
        const questionsList = document.getElementById('questions-list');
        questionsList.innerHTML = '';

        const questionLabels = {
            'overview': 'Game Overview & Scenario',
            'challenges': 'Challenges & Problems',
            'twists': 'Unexpected Twists',
            'conclusion': 'Expected Conclusion'
        };

        tabletop.questions.forEach(q => {
            const div = document.createElement('div');
            div.className = `question-card ${q.answer ? 'answered' : ''}`;
            div.innerHTML = `
                <h3>${questionLabels[q.question_type] || q.question_type}</h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${q.question_text}</p>
                ${q.answer ?
                    `<div style="background: var(--light); padding: 1rem; border-radius: 5px; margin-top: 0.5rem;">
                        <strong>Answer:</strong><br>${escapeHtml(q.answer)}
                    </div>` :
                    `<p style="color: var(--warning); font-style: italic;">Not yet answered</p>`
                }
            `;
            questionsList.appendChild(div);
        });
    }

    async function deleteTabletop() {
        if (!confirm('Are you sure you want to delete this tabletop? This cannot be undone.')) {
            return;
        }

        try {
            const response = await apiCall(`/api/tabletops/${tabletopId}`, 'DELETE');

            if (response.ok) {
                window.location.href = '/app/dashboard';
            } else {
                alert('Failed to delete tabletop');
            }
        } catch (error) {
            alert('An error occurred');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    loadTabletop();
</script>
{% endblock %}
